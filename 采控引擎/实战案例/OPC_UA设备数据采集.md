# OPC_UA设备数据采集

本次分享一篇通过使用IoT-Fast以及KEPServerv6模拟器，实现OpcUa协议设备的数据采集软文。IoT-Fast是一款集合了数据采集、上报云端、图形组态为一体的软件

文章主要共分为五个部分：

+ OpcUa服务器环境搭建

> 简单介绍使用KEPServerv6如何进行OPC_UA的服务器搭建。
>

+ **IoT-Fast**-采集控制系统

> 对底层设备进行数据读取、写入的配置界面，还可以进行数据处理。
>

+ **IoT-Fast**-云平台

> 将采集控制系统收集的数据进行分类展示、告警阈值设置、历史数据查询等功能。
>

+ **IoT-Fast**-云组态

> 进行2D组态，组态元素绑定云平台上展示的数据，来进行动作的执行或是数据展示。
>

+ **IoT-Fast**-微信小程序/App

> 通过微信小程序或者手机app进行远程数据的查看，以及动作的执行。
>

## 一 OpcUa服务器环境搭建
### 1.1 KEPServerv6软件的下载
链接：[https://pan.baidu.com/s/1ZZg2qCWEPQNcjAWN4d15fg](https://pan.baidu.com/s/1ZZg2qCWEPQNcjAWN4d15fg)  
       提取码：oo92

### 1.2 KEPServerv6配置
1.安装包下载完成后，解压单击安装，按提示安装完，中间记住所设置的密码即可。

![20220629155753.png](./img/leRQgCA8GhowybPz/1656659668062-c0b5a37d-2da0-4124-ab73-6bce5a2faccc-137261.png)

2.安装完成后，出现下图(windows 10系统)，点击OPC UA Configuration 配置服务器用户.

![20220629155002.png](./img/leRQgCA8GhowybPz/1656659667262-6201aa42-a92d-4c4e-9784-32095dd75a16-635713.png)

3.弹出如下窗口，输入自己的用户名和密码即可.这里用户名是指定的或默认的Administrator，密码是指定的或123456

![20220629155035.png](./img/leRQgCA8GhowybPz/1656659667211-ed24d3ed-ae0b-4e68-b4f0-a88398d6bd6a-249276.png)

4.成功后进入配置界面如下

![20220629155307.png](./img/leRQgCA8GhowybPz/1656659668054-6589d5ae-a8ac-48e8-82f2-8e8603af7d43-565997.png)

5.双击URL弹出如下窗口，按所示设置即可，如果自己要加密则可以选择加密

![20220629160333.png](./img/leRQgCA8GhowybPz/1656659667451-f4c3ca3d-926d-4d51-991e-6837250ad248-754328.png)

6.上述操作完成，如下点击设置

![20220629161714.png](./img/leRQgCA8GhowybPz/1656659667312-53cb65d9-cf89-42d3-973c-e97474cd641d-337344.png)

7.添加OPC_UA服务器用户，我的是my_opc_ua，设置密码后，点击确定和应用

![20220629161501.png](./img/leRQgCA8GhowybPz/1656659667168-a6e951f2-ae84-4bde-a674-68643daef5e7-786543.png)

![20220629161827.png](./img/leRQgCA8GhowybPz/1656659667229-01d9f4a8-6445-4e4f-9cce-8a17e6cb3e13-463364.png)

8.选择KEPServerEX 6 Configuration进入配置界面

![20220629161921.png](./img/leRQgCA8GhowybPz/1656659667164-ba9ecf5f-7223-472a-b533-d1d59b685944-493754.png)

9.右击项目点击弹出的属性如下，按图示设置OPC_UA的匿名链接

![20220629162030.png](./img/leRQgCA8GhowybPz/1656659667332-bc948b82-db9a-47db-9a74-53efcad1cee8-732905.png)

10.按上面设置完毕，则允许匿名登陆和用户名密码登录的OPC_UA服务器搭建完毕，下面开始设置服务器通信变量。

### 1.3 KEPServerv6设置通信变量
(1)打开KEPServerEX 6 Configuration，新建通道,选择Simulator。

![20220629162909.png](./img/leRQgCA8GhowybPz/1656659667277-4a99763d-3f67-4f86-bf1c-a1d65eda9a90-859361.png)

![20220629184531.png](./img/leRQgCA8GhowybPz/1656659667666-82ececf4-b9d7-4fdc-aa11-15458ce6ddd7-046462.png)



![20220629184617.png](./img/leRQgCA8GhowybPz/1656659667217-ce92e25a-baa4-4a0a-a942-aa64198568f4-579096.png)

![20220629184632.png](./img/leRQgCA8GhowybPz/1656659667190-c486fb85-97de-4a0e-9f15-da730241f971-082406.png)

![20220629184659.png](./img/leRQgCA8GhowybPz/1656659667217-cb4155cb-adc3-4e9e-b19d-f58b8a3c5fef-242002.png)

![20220629184807.png](./img/leRQgCA8GhowybPz/1656659667243-54f8ad13-b317-442e-bf34-8ce531b624a3-065396.png)

(2)给通道添加设备，设备名plc，一步一步直到完成。

![20220629184928.png](./img/leRQgCA8GhowybPz/1656659667189-b707ea23-f1e2-4d68-857a-f6745dfad4cc-802793.png)

![20220629185006.png](./img/leRQgCA8GhowybPz/1656659667227-0656114a-eebb-4707-95c3-a36ac1fbb1d1-090053.png)

![20220629185022.png](./img/leRQgCA8GhowybPz/1656659667225-036e9b39-a1b4-4432-810a-b895126ed28a-461284.png)

![20220629185043.png](./img/leRQgCA8GhowybPz/1656659667381-cadf2b8e-e4be-4c3d-a496-a5a70edeff82-168306.png)

![20220629185103.png](./img/leRQgCA8GhowybPz/1656659667184-1e892201-753b-4cd0-abb7-39d8bbedb666-360810.png)

(3)创建标记组

![20220629185317.png](./img/leRQgCA8GhowybPz/1656659667283-cb8ddef2-0906-42ec-a947-35dce206d917-518864.png)

![20220629185429.png](./img/leRQgCA8GhowybPz/1656659667296-8803c1c5-0fa4-429f-a131-0f44a17e7946-961572.png)

(4)新建标记，取名x1,地址输入x1,数据类型选择浮点型，客户端访问方式为写

![20220629185633.png](./img/leRQgCA8GhowybPz/1656659667498-fffca978-5523-4b63-ac9a-5f462ec151f0-148170.png)

(5)重复以上操作新建3个标记， 这里的地址需要根据数据类型计算占用的空间数，地址填错有可能影响数据正确性，比如说浮点型数据占两位，那么第二个浮点数据地址为x(n+2)。

![20220701085328.png](./img/leRQgCA8GhowybPz/1656659667245-de926740-15fe-465c-a7f0-d47674f3b053-956302.png)

随后，我们打开客户端，将地址复制过去，点击连接，即可看到显示连接成功。

![20220701091024.png](./img/leRQgCA8GhowybPz/1656659667248-eb7c7e2f-4647-42d8-bb46-c650079f36dc-936129.png)

## 二 IoT-Fast-采集控制系统
打开IoT-Fast的**采集控制**系统，在左侧采集引擎节点区找到**OpcUa**，按住鼠标左键拖入到中间的配置区。

![20220701093057.png](./img/leRQgCA8GhowybPz/1656659667519-46b9815a-c5ad-44a0-9966-48654cc25096-991520.png)

再从从左侧通用节点区拉出**定时器**和**调试**控件，与**OpcUa**控件节点连起来，以完成网络中信息的发送接收和转发。（定时器用于定时或手动触发采集控件采集信息，调试是为了采集控件采集到的数据展示至右侧数据窗口。)

![20220701093248.png](./img/leRQgCA8GhowybPz/1656659667556-6b5fcc90-cc31-4a6c-a47c-26a95ed5f7c2-654693.png)

双击**OpcUa**控件配置OpcUa的连接地址以及采集的数据字典（点位）。

![20220701093443.png](./img/leRQgCA8GhowybPz/1656659667329-c6931c47-4bdd-4be2-86d4-3bb4aa61e274-631973.png)

根据搭建的OpcUa服务环境地址配置，点击**OpcUa**组件地址配置项，按要求填入服务器配置信息。通讯模式选择**实时**。

![20220701095613.png](./img/leRQgCA8GhowybPz/1656659667334-b7d13542-b8a6-43d2-867c-6fac4b858f32-060918.png)

按照搭建过程中设置的点位,将相关的点位进行采集。

![20220701102546.png](./img/leRQgCA8GhowybPz/1656659667322-84f15387-6d81-4229-8052-d5a14dc700e3-325266.png)

![20220701102647.png](./img/leRQgCA8GhowybPz/1656659667317-3f6cc977-640a-4fd7-b825-4ae9e698c2a6-761283.png)

双击**定时器**自定义设置定时器采集时间。

![20220701102736.png](./img/leRQgCA8GhowybPz/1656659667332-0ae0fb02-8852-4d5a-8a43-8d0eb6d81840-202584.png)

然后点击右上角的**部署**按钮，部署完成后**OpcUa**显示已连接，右侧的界面调到**调试窗口**显示x1、x2、x3共计3条数据。

![20220701102932.png](./img/leRQgCA8GhowybPz/1656659667294-5de11d53-1dbc-4582-a689-e448e89670b0-717637.png)

如果需要对点位进行控制，同样的操作，在左侧**控制**引擎节点区找到**OpcUa**，按照下图进行连接。

![20220701103548.png](./img/leRQgCA8GhowybPz/1656659667491-2ef1019d-afcf-4624-8d76-4a4ce1e9c0c2-711573.png)

此时地址会自动配置好，但是需要添加一下需要控制的点位，并写入需要设定的状态值。

![20220701103733.png](./img/leRQgCA8GhowybPz/1656659667327-1788928d-81e2-412b-a21e-3fb4d2359f8f-714957.png)

点击**部署**按钮后，在写入控制**OpcUa**引擎前点击定时器触发，右方调试窗口提示写入操作成功后。我们再点击采集**OpcUa**引擎前的定时器，即可看到数据变为100、200、300。

![20220701103955.png](./img/leRQgCA8GhowybPz/1656659668287-cf3f8e3f-c16e-4fd5-9ecd-51778c9bf45c-753809.png)

这些数据读取控制没问题后，就可以将数据传到**云平台**显示，然后再进行**云组态**。

## 三 IoT-Fast-云平台
### 3.1 创建产品
点击云平台按钮进入**云平台**首页。

![20220601135713.png](./img/leRQgCA8GhowybPz/1654148584128-e02e9776-603a-4086-bdd4-8a6aaf3b2ba9-886152.png)

点击左侧**产品中心**-**产品开发**，新增一个产品。

![20220615083518.png](./img/leRQgCA8GhowybPz/1655282192376-95925652-9b36-4c54-8f56-90ac4e8e1082-508208.png)

查看创建的产品，在**功能定义**-**自定义参数**中新增属性。

![20220601140331.png](./img/leRQgCA8GhowybPz/1654148584120-ce0957d1-9d32-4825-b814-349ee980cf9d-299268.png)

创建配置如下，**标识符**与**采集控制**上的**key**值对应，同一个产品中不能有重复的**标识符**。

![20220701111200.png](./img/leRQgCA8GhowybPz/1656659667292-6eba22a2-8481-4b37-a1f3-648d3aa65b60-235627.png)

添加完成后如下：

![20220701111324.png](./img/leRQgCA8GhowybPz/1656659667312-6bef1c6e-79e0-40c4-925d-1cc0b84805c6-716282.png)

然后在**功能定义**-**分组**中创建一个上报分组，类型选择上报，将左边的点位全选，点击右箭头，加入到当前分组中。

![20220701111535.png](./img/leRQgCA8GhowybPz/1656659667319-95c64bcd-dd35-423d-aba0-fdad031cd601-037372.png)

相同操作，再创建一个下发的分组。

![20220701111651.png](./img/leRQgCA8GhowybPz/1656659667306-bf4a602d-e24b-4dfd-8a97-53df41135b35-322238.png)

如此下文中添加的设备是关联该产品的情况下，自动附带以上上报下发分组的属性，方便批量设备增加的过程。

### 3.2 添加设备
点击**产品中心**-**设备管理**，在该产品下增加一个设备。

![20220701111932.png](./img/leRQgCA8GhowybPz/1656659667304-1af9abb5-cf48-4ecf-98b3-cb4f2fb67aa5-397588.png)

然后就是云平台和采集控制中的属性进行绑定，我们需要回到**采集控制**系统，从左侧云平台中拉出**微联云上行**以及**微联云下行**两个控件，用于将采集的数据上报**云平台**并在云端进行状态控制下发。

![20220701135912.png](./img/leRQgCA8GhowybPz/1656659667340-7d444d96-4fb6-4b45-96c3-21dc0e0a69bf-027040.png)

双击控件选择将数据上报到**云平台**的OpcUa产品、设备和分组中。

![20220701135944.png](./img/leRQgCA8GhowybPz/1656659667302-5223a6a0-696e-48c1-a7ef-1635c25dcbec-209718.png)

流程中通过调试，需要增加一个function函数对云端下发的数据做解析，只取负载中的params字段传到OpcUa控制引擎组件中。

![20220701140123.png](./img/leRQgCA8GhowybPz/1656659667593-8c13fefd-6119-42ea-9490-edf913cf5d92-993615.png)

### 3.3 查看数据
回到**云平台**，查看设备的**运行状态**，可以看到数据已经上传上来了。

![20220701140517.png](./img/leRQgCA8GhowybPz/1656659667387-d6bec364-d9a3-4f0b-9edc-d0ecb6e2d1f4-589318.png)

在**设备调试**中，选择**下发**方式，填下下发的状态值，点击**立即发送**。

![20220701140636.png](./img/leRQgCA8GhowybPz/1656659667333-0133e329-91f8-4a29-91b8-407cac2ddcf7-056031.png)

返回**运行状态**，即可查看OpcUa最新采集上报的数据。

![20220701140924.png](./img/leRQgCA8GhowybPz/1656659667358-188f9fad-90b7-4554-9543-21d5932ae274-670141.png)

这样便配置好了**采集控制**和**云平台**的联动，接着可以去**云组态**进行2D组态，用图形展示数据。

## 四 IoT-Fast-云组态
### 4.1 添加应用图纸
点击云组态按钮进入**云组态**首页。

![20220601142042.png](./img/leRQgCA8GhowybPz/1654148584144-8320f9a9-eceb-43ec-b27a-734000bfa1f7-045168.png)

先新建一个项目，填写项目名称，保存，进入项目。

![20220601142113.png](./img/leRQgCA8GhowybPz/1654148584153-c6bd41b1-c3bb-4a0f-a96c-dac62e3bfaf9-502702.png)

点击**应用**-**我的应用**，点击图示位置新增一张图纸，来构建组态。

![20220601142222.png](./img/leRQgCA8GhowybPz/1654148584069-bc5ff08b-f648-4600-a67a-3023cfd45a90-825630.png)

填写图纸名称后就可以开始画组态图了。

![20220425141925.png](./img/leRQgCA8GhowybPz/1651735624498-6170a292-8c1e-43b7-b4a0-46d0664f02eb-773692.png)

### 4.2 组态绘制基础部分
![20220615154148.png](./img/leRQgCA8GhowybPz/1655282192481-462f9da3-d38b-45e7-96b0-7aefc2d608dc-546338.png)

由上面划分可知，我们可以在**设计**中设计自己需要的组件。设计完成的个性化组件可以直接拉到后面你所创建项目图纸中，重复使用，方便快捷

![20220615154810.png](./img/leRQgCA8GhowybPz/1655282192622-4c8508aa-0617-4adc-ba25-fc257b20cea3-296615.png)

当然也可在左侧菜单栏中选择**图标**使用现成的组件

![20220615154638.png](./img/leRQgCA8GhowybPz/1655282193366-1cd4733b-2e4a-482c-bb19-41524dbb3531-070699.png)

可以点击**资源**，上传截图的图片资源。

![20220615154908.png](./img/leRQgCA8GhowybPz/1655282192531-3d557ca6-7ba7-4f7d-8940-b3ebf3c19a8a-078844.png)

在**常用功能栏**进行所需组件的绘制，例如添加图形、添加文本、图形之间的对齐等。

![20220701144809.png](./img/leRQgCA8GhowybPz/1656659667436-3baf974d-dd1e-4e34-b9a1-f11498cc990a-672225.png)

在**编辑操作区**主要是对图形边框、背影、是否立体进行操作。

![20220701145047.png](./img/leRQgCA8GhowybPz/1656659667385-c69d39a8-8dd0-4e4d-b728-52daf4f213bb-392208.png)

### 4.3 绑定云平台数据
点击**数据源**按钮，在弹出的标签页中**选择数据源**-设备，**来源**-我的，**产品**-云平台创建的产品，**设备**-云平台创建的设备，**属性**-选择燃气浓度，点击确定。图形下方的的电源指示灯以及其他的设备数据源同理，进行绑定。

![20220701145136.png](./img/leRQgCA8GhowybPz/1656659667388-9d4cbf08-c45a-463c-aeaa-71836e1efcdb-568978.png)

![20220701145154.png](./img/leRQgCA8GhowybPz/1656659667331-505428a7-06c9-4819-9f6a-2e212d0dc401-171818.png)

全部完成后点击**保存**，然后点击右上角的**预览**，即可查看组态OpcUa的采集动态效果。

![20220701145235.png](./img/leRQgCA8GhowybPz/1656659667360-b0836f50-8f84-4e25-a5cf-b0fd692a9d25-079684.png)

## 五 IoT-Fast-微信小程序/APP
软件上的数据支持在**微信小程序**或者**APP**上查看，小程序和APP的二维码在**云平台**首页的右侧，目前只支持安卓APP，ios的用户可以直接用微信小程序查看。

![1699001367692-a9045990-c453-47bc-a15e-9efa823434eb.png](./img/leRQgCA8GhowybPz/1699001367692-a9045990-c453-47bc-a15e-9efa823434eb-417634.png)

扫码进入**IoT-Fast**小程序，输入PC端注册的账号密码。

![20220609085115.png](./img/leRQgCA8GhowybPz/1655260457648-c7a7ade4-f89a-4192-a876-31ef30330d22-426830.png)

进入首页，可以看到产品和设备数量，点击**设备**查看该账号下的所有设备。

![20220609085234.png](./img/leRQgCA8GhowybPz/1655282192455-d1522dab-ad9b-4f65-bb53-fb00caff9cad-869340.png)

选择OpcUa，点击查看。

![20220701145351.png](./img/leRQgCA8GhowybPz/1656659667411-fc07ed7f-931f-4c29-9116-5480b17b2ae2-368185.png)

通过点击**运行状态设备控制**可以分别在对应的界面中查看OpcUa点位数据或者控制相关点位的数据。

![20220701150702.png](./img/leRQgCA8GhowybPz/1656659667515-be2fd7b9-e787-480f-ae3f-d84061c0204a-394277.png)

回到首页，点击**组态**查看该账号下的所有组态，选择OpcUa，点击查看。

![20220701150921.png](./img/leRQgCA8GhowybPz/1656659667375-a3af6ba9-a664-4a13-9135-bac950780dd6-273318.png)

效果和PC端是一样的。

![20220701151021.png](./img/leRQgCA8GhowybPz/1656659667343-66b5d4f1-32f8-4fd1-ba46-600913c4a7cc-035749.png)



> 更新: 2024-03-21 14:20:14  
> 原文: <https://www.yuque.com/iot-fast/ckyq/dytctb>